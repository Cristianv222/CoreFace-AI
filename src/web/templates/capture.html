{% extends "base.html" %}

{% block title %}Captura Inteligente - CoreFace-AI v2.0{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header con Estado -->
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h2><i class="bi bi-camera-fill text-primary"></i> Captura Inteligente v2.0</h2>
                <p class="text-muted">Sistema guiado con verificaci√≥n de calidad autom√°tica</p>
            </div>
            <div class="badge-container">
                <span class="badge bg-success fs-6">
                    <i class="bi bi-shield-check"></i> Calidad Autom√°tica
                </span>
                <span class="badge bg-info fs-6">
                    <i class="bi bi-camera-reels"></i> 9 Variaciones
                </span>
            </div>
        </div>
    </div>

    <!-- Selector de Modo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stat-card">
                <h5 class="text-white mb-3">
                    <i class="bi bi-person-circle text-primary"></i> Paso 1: Selecciona el modo
                </h5>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="modo" id="modoNuevo" value="nuevo" checked>
                    <label class="btn btn-outline-primary btn-lg" for="modoNuevo">
                        <i class="bi bi-person-plus-fill"></i> Nueva Persona
                        <small class="d-block opacity-75">Crear nuevo registro</small>
                    </label>
                    
                    <input type="radio" class="btn-check" name="modo" id="modoExistente" value="existente">
                    <label class="btn btn-outline-primary btn-lg" for="modoExistente">
                        <i class="bi bi-person-fill-add"></i> Agregar a Existente
                        <small class="d-block opacity-75">Continuar capturando</small>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Nombre -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stat-card">
                <h5 class="text-white mb-3">
                    <i class="bi bi-pencil-fill text-primary"></i> Paso 2: Identificaci√≥n
                </h5>
                
                <!-- Nueva Persona -->
                <div id="nuevoForm">
                    <label for="nombre" class="form-label text-white mb-2">
                        Nombre completo de la persona:
                    </label>
                    <input type="text" id="nombre" class="form-control form-control-lg" 
                           placeholder="Ej: Cristian P√©rez"
                           autocomplete="off">
                    <small class="text-muted mt-2 d-block">
                        <i class="bi bi-info-circle"></i> Este nombre se usar√° para identificar a la persona
                    </small>
                </div>
                
                <!-- Persona Existente -->
                <div id="existenteForm" style="display: none;">
                    <label for="personaSelect" class="form-label text-white mb-2">
                        Selecciona una persona registrada:
                    </label>
                    <select id="personaSelect" class="form-select form-select-lg">
                        <option value="">Cargando personas...</option>
                    </select>
                    <div id="personaInfo" class="mt-3" style="display: none;">
                        <div class="alert alert-info border-0 d-flex align-items-center">
                            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                            <div>
                                <strong id="personaNombre"></strong> tiene 
                                <strong id="personaFotos">0</strong> fotos.
                                Se continuar√° agregando m√°s fotos.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    <div id="alertContainer"></div>

    <!-- Grid Principal -->
    <div class="row g-4">
        <!-- Columna de Video -->
        <div class="col-lg-7">
            <div class="stat-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-white mb-0">
                        <i class="bi bi-camera-video-fill text-success"></i> Paso 3: Vista de C√°mara
                    </h5>
                    <span id="qualityBadge" class="badge bg-secondary">
                        <i class="bi bi-circle-fill"></i> En Espera
                    </span>
                </div>
                
                <div class="video-container mb-3">
                    <video id="video" autoplay playsinline class="w-100"></video>
                    <canvas id="overlay" class="overlay-canvas"></canvas>
                    
                    <!-- Overlay de Instrucciones -->
                    <div id="instructionOverlay" class="instruction-overlay">
                        <div class="instruction-content">
                            <div class="instruction-icon mb-3">
                                <span id="variationIcon" class="fs-1">üòê</span>
                            </div>
                            <h3 id="variationTitle" class="text-white mb-2">FRONTAL NORMAL</h3>
                            <div id="instructionsList" class="instruction-list">
                                <p class="mb-1">‚Ä¢ Mira directo a la c√°mara</p>
                                <p class="mb-1">‚Ä¢ Expresi√≥n neutral</p>
                                <p class="mb-0">‚Ä¢ Sin gafas ni accesorios</p>
                            </div>
                            <div class="preparation-countdown" id="countdownDisplay" style="display: none;">
                                <div class="countdown-number">3</div>
                                <div class="countdown-text">PREPARATE</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button id="startBtn" class="btn btn-success flex-fill btn-lg">
                        <i class="bi bi-camera-video-fill"></i> Iniciar C√°mara
                    </button>
                    <button id="stopBtn" class="btn btn-danger flex-fill btn-lg" disabled>
                        <i class="bi bi-stop-circle-fill"></i> Detener
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Columna de Control -->
        <div class="col-lg-5">
            <div class="stat-card h-100">
                <h5 class="text-white mb-3">
                    <i class="bi bi-collection-fill text-warning"></i> Paso 4: Control de Captura
                </h5>
                
                <!-- Progreso General -->
                <div class="progress-card mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-white">
                            <i class="bi bi-bar-chart-fill text-primary"></i> Progreso General
                        </span>
                        <span class="text-white">
                            <strong id="progressPercent">0%</strong>
                        </span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">
                            <i class="bi bi-check-circle"></i> Capturadas: 
                            <strong id="fotosCapturadas" class="text-success">0</strong>
                        </small>
                        <small class="text-muted">
                            Total: <strong id="fotosTotal" class="text-info">100</strong>
                        </small>
                    </div>
                </div>

                <!-- Variaci√≥n Actual -->
                <div class="variation-card mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <span class="variation-icon me-2" id="currentVariationIcon">üòê</span>
                        <div class="flex-fill">
                            <h6 class="text-white mb-0" id="currentVariation">FRONTAL NORMAL</h6>
                            <small class="text-muted">Variaci√≥n actual</small>
                        </div>
                        <div class="text-end">
                            <strong class="text-primary fs-5" id="variationProgress">0/15</strong>
                        </div>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div id="variationBar" class="progress-bar bg-success" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Estad√≠sticas en Tiempo Real -->
                <div class="stats-grid mb-3">
                    <div class="stat-item">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        <div>
                            <small class="text-muted d-block">Aceptadas</small>
                            <strong class="text-white" id="fotosAceptadas">0</strong>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-x-circle-fill text-danger"></i>
                        <div>
                            <small class="text-muted d-block">Rechazadas</small>
                            <strong class="text-white" id="fotosRechazadas">0</strong>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-speedometer2 text-warning"></i>
                        <div>
                            <small class="text-muted d-block">Calidad</small>
                            <strong class="text-white" id="calidadPromedio">-</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Bot√≥n de Captura Principal -->
                <button id="captureBtn" class="btn btn-primary w-100 btn-lg mb-3" disabled>
                    <i class="bi bi-camera-fill"></i> Iniciar Captura Guiada
                </button>

                <!-- Bot√≥n de Saltar (opcional) -->
                <button id="skipBtn" class="btn btn-outline-warning w-100 mb-3" style="display: none;">
                    <i class="bi bi-skip-forward-fill"></i> Saltar Variaci√≥n Opcional
                </button>
                
                <!-- Lista de Variaciones -->
                <div class="variations-list">
                    <h6 class="text-info mb-2">
                        <i class="bi bi-list-check"></i> Variaciones Planificadas:
                    </h6>
                    <div class="scrollable-list">
                        <div class="variation-item" data-variation="frontal">
                            <span class="variation-icon">üòê</span>
                            <div class="variation-info">
                                <strong>Frontal Normal</strong>
                                <small class="text-muted">15 fotos</small>
                            </div>
                            <span class="variation-status">
                                <i class="bi bi-circle text-muted"></i>
                            </span>
                        </div>
                        <div class="variation-item" data-variation="sonrisa">
                            <span class="variation-icon">üòä</span>
                            <div class="variation-info">
                                <strong>Sonriendo</strong>
                                <small class="text-muted">10 fotos</small>
                            </div>
                            <span class="variation-status">
                                <i class="bi bi-circle text-muted"></i>
                            </span>
                        </div>
                        <div class="variation-item" data-variation="perfil_izq">
                            <span class="variation-icon">üëà</span>
                            <div class="variation-info">
                                <strong>Perfil Izquierdo</strong>
                                <small class="text-muted">10 fotos</small>
                            </div>
                            <span class="variation-status">
                                <i class="bi bi-circle text-muted"></i>
                            </span>
                        </div>
                        <div class="variation-item" data-variation="perfil_der">
                            <span class="variation-icon">üëâ</span>
                            <div class="variation-info">
                                <strong>Perfil Derecho</strong>
                                <small class="text-muted">10 fotos</small>
                            </div>
                            <span class="variation-status">
                                <i class="bi bi-circle text-muted"></i>
                            </span>
                        </div>
                        <div class="variation-item" data-variation="arriba">
                            <span class="variation-icon">üëÜ</span>
                            <div class="variation-info">
                                <strong>Mirando Arriba</strong>
                                <small class="text-muted">8 fotos</small>
                            </div>
                            <span class="variation-status">
                                <i class="bi bi-circle text-muted"></i>
                            </span>
                        </div>
                        <div class="variation-item" data-variation="abajo">
                            <span class="variation-icon">üëá</span>
                            <div class="variation-info">
                                <strong>Mirando Abajo</strong>
                                <small class="text-muted">8 fotos</small>
                            </div>
                            <span class="variation-status">
                                <i class="bi bi-circle text-muted"></i>
                            </span>
                        </div>
                        <div class="variation-item" data-variation="con_gafas">
                            <span class="variation-icon">ü§ì</span>
                            <div class="variation-info">
                                <strong>Con Gafas</strong>
                                <small class="text-muted">12 fotos (opcional)</small>
                            </div>
                            <span class="variation-status">
                                <i class="bi bi-circle text-muted"></i>
                            </span>
                        </div>
                        <div class="variation-item" data-variation="tapado">
                            <span class="variation-icon">üò∑</span>
                            <div class="variation-info">
                                <strong>Cara Tapada</strong>
                                <small class="text-muted">12 fotos</small>
                            </div>
                            <span class="variation-status">
                                <i class="bi bi-circle text-muted"></i>
                            </span>
                        </div>
                        <div class="variation-item" data-variation="diferentes">
                            <span class="variation-icon">üé≠</span>
                            <div class="variation-info">
                                <strong>Variaciones Libres</strong>
                                <small class="text-muted">15 fotos</small>
                            </div>
                            <span class="variation-status">
                                <i class="bi bi-circle text-muted"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<canvas id="canvas" style="display: none;"></canvas>
{% endblock %}

{% block extra_js %}
<script>
// ============================================================
// CoreFace-AI v2.0 - Sistema de Captura Inteligente
// ============================================================

// Variables globales
let video, canvas, ctx, overlay, overlayCtx;
let stream = null;
let capturing = false;
let captureInterval = null;
let currentMode = 'nuevo';
let selectedPersona = null;

// Estad√≠sticas
let stats = {
    fotosCapturadas: 0,
    fotosAceptadas: 0,
    fotosRechazadas: 0,
    calidadTotal: 0,
    variacionIndex: 0
};

// Configuraci√≥n de variaciones
const variaciones = [
    { id: 'frontal', nombre: 'FRONTAL NORMAL', icon: 'üòê', fotos: 15, obligatorio: true,
      instrucciones: ['Mira directo a la c√°mara', 'Expresi√≥n neutral', 'Sin gafas ni accesorios'] },
    { id: 'sonrisa', nombre: 'SONRIENDO', icon: 'üòä', fotos: 10, obligatorio: true,
      instrucciones: ['Sonr√≠e naturalmente', 'Mira a la c√°mara', 'Muestra los dientes'] },
    { id: 'perfil_izq', nombre: 'PERFIL IZQUIERDO', icon: 'üëà', fotos: 10, obligatorio: true,
      instrucciones: ['Gira tu cabeza a la izquierda', 'Perfil de 45 grados', 'Mant√©n la postura'] },
    { id: 'perfil_der', nombre: 'PERFIL DERECHO', icon: 'üëâ', fotos: 10, obligatorio: true,
      instrucciones: ['Gira tu cabeza a la derecha', 'Perfil de 45 grados', 'Mant√©n la postura'] },
    { id: 'arriba', nombre: 'MIRANDO ARRIBA', icon: 'üëÜ', fotos: 8, obligatorio: true,
      instrucciones: ['Inclina tu cabeza hacia arriba', 'Mira al techo', 'Mant√©n el cuello recto'] },
    { id: 'abajo', nombre: 'MIRANDO ABAJO', icon: 'üëá', fotos: 8, obligatorio: true,
      instrucciones: ['Inclina tu cabeza hacia abajo', 'Mira al suelo', 'Sin exagerar'] },
    { id: 'con_gafas', nombre: 'CON GAFAS', icon: 'ü§ì', fotos: 12, obligatorio: false,
      instrucciones: ['Ponte tus gafas', 'Mira directo a la c√°mara', 'Variaci√≥n opcional'] },
    { id: 'tapado', nombre: 'CARA TAPADA', icon: 'üò∑', fotos: 12, obligatorio: true,
      instrucciones: ['Cubre parte de tu cara', 'Con bufanda o mascarilla', 'Diferentes posiciones'] },
    { id: 'diferentes', nombre: 'VARIACIONES LIBRES', icon: 'üé≠', fotos: 15, obligatorio: true,
      instrucciones: ['Expresiones variadas', 'Diferentes √°ngulos', 'Movimientos naturales'] }
];

// ============================================================
// INICIALIZACI√ìN
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ CoreFace-AI v2.0 - Inicializando...');
    
    // Obtener elementos
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');
    overlay = document.getElementById('overlay');
    overlayCtx = overlay.getContext('2d');
    
    // Event Listeners
    document.getElementById('startBtn').addEventListener('click', startCamera);
    document.getElementById('stopBtn').addEventListener('click', stopCamera);
    document.getElementById('captureBtn').addEventListener('click', startCapture);
    document.getElementById('skipBtn').addEventListener('click', skipVariation);
    
    // Modo de captura
    document.querySelectorAll('input[name="modo"]').forEach(radio => {
        radio.addEventListener('change', handleModeChange);
    });
    
    // Selector de persona existente
    document.getElementById('personaSelect').addEventListener('change', handlePersonaChange);
    
    // Cargar personas si existe el modo
    loadPersonas();
    
    // Verificar soporte de c√°mara
    checkCameraSupport();
    
    console.log('‚úÖ Inicializaci√≥n completada');
});

// ============================================================
// VERIFICACI√ìN DE SOPORTE
// ============================================================
function checkCameraSupport() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showAlert('Tu navegador no soporta acceso a la c√°mara. Usa Chrome, Firefox o Safari moderno.', 'danger');
        document.getElementById('startBtn').disabled = true;
        return false;
    }
    
    // Verificar si es HTTPS (excepto localhost)
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        showAlert('‚ö†Ô∏è Se requiere HTTPS para acceder a la c√°mara', 'warning');
    }
    
    return true;
}

// ============================================================
// GESTI√ìN DE C√ÅMARA
// ============================================================
async function startCamera() {
    try {
        console.log('üìπ Solicitando acceso a la c√°mara...');
        
        const constraints = {
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'user' // C√°mara frontal en m√≥viles
            },
            audio: false
        };
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            // Configurar canvas con las dimensiones del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            overlay.width = video.videoWidth;
            overlay.height = video.videoHeight;
            
            console.log(`‚úÖ C√°mara iniciada: ${video.videoWidth}x${video.videoHeight}`);
        };
        
        // Actualizar UI
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('captureBtn').disabled = false;
        document.getElementById('qualityBadge').className = 'badge bg-success';
        document.getElementById('qualityBadge').innerHTML = '<i class="bi bi-circle-fill"></i> C√°mara Activa';
        
        showAlert('‚úÖ C√°mara iniciada correctamente', 'success', 2000);
        
    } catch (error) {
        console.error('‚ùå Error al acceder a la c√°mara:', error);
        handleCameraError(error);
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        stream = null;
    }
    
    if (capturing) {
        stopCapture();
    }
    
    // Actualizar UI
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('captureBtn').disabled = true;
    document.getElementById('qualityBadge').className = 'badge bg-secondary';
    document.getElementById('qualityBadge').innerHTML = '<i class="bi bi-circle-fill"></i> C√°mara Detenida';
    
    console.log('‚èπÔ∏è C√°mara detenida');
}

function handleCameraError(error) {
    let message = 'Error al acceder a la c√°mara: ';
    
    if (error.name === 'NotAllowedError') {
        message = '‚ùå Permiso denegado. Por favor, permite el acceso a la c√°mara en la configuraci√≥n de tu navegador.';
    } else if (error.name === 'NotFoundError') {
        message = '‚ùå No se encontr√≥ ninguna c√°mara. Verifica que tu dispositivo tenga una c√°mara conectada.';
    } else if (error.name === 'NotReadableError') {
        message = '‚ùå La c√°mara est√° siendo usada por otra aplicaci√≥n. Cierra otras aplicaciones y vuelve a intentar.';
    } else if (error.name === 'OverconstrainedError') {
        message = '‚ùå No se pudo cumplir con las restricciones de la c√°mara. Intenta con otra c√°mara.';
    } else {
        message += error.message;
    }
    
    showAlert(message, 'danger');
}

// ============================================================
// GESTI√ìN DE MODOS
// ============================================================
function handleModeChange(e) {
    currentMode = e.target.value;
    
    if (currentMode === 'nuevo') {
        document.getElementById('nuevoForm').style.display = 'block';
        document.getElementById('existenteForm').style.display = 'none';
        selectedPersona = null;
    } else {
        document.getElementById('nuevoForm').style.display = 'none';
        document.getElementById('existenteForm').style.display = 'block';
        loadPersonas();
    }
}

async function loadPersonas() {
    try {
        const response = await fetch('/api/get_personas');
        
        if (!response.ok) {
            console.warn('‚ö†Ô∏è No se pudieron cargar las personas');
            return;
        }
        
        const data = await response.json();
        const select = document.getElementById('personaSelect');
        
        select.innerHTML = '<option value="">Selecciona una persona...</option>';
        
        if (data.personas && data.personas.length > 0) {
            data.personas.forEach(persona => {
                const option = document.createElement('option');
                option.value = persona.nombre;
                option.textContent = `${persona.nombre} (${persona.num_fotos} fotos)`;
                option.dataset.fotos = persona.num_fotos;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">No hay personas registradas</option>';
        }
        
    } catch (error) {
        console.error('Error cargando personas:', error);
    }
}

function handlePersonaChange(e) {
    const select = e.target;
    selectedPersona = select.value;
    
    if (selectedPersona) {
        const fotos = select.options[select.selectedIndex].dataset.fotos || 0;
        document.getElementById('personaNombre').textContent = selectedPersona;
        document.getElementById('personaFotos').textContent = fotos;
        document.getElementById('personaInfo').style.display = 'block';
    } else {
        document.getElementById('personaInfo').style.display = 'none';
    }
}

// ============================================================
// PROCESO DE CAPTURA
// ============================================================
async function startCapture() {
    // Validar nombre
    let nombre;
    if (currentMode === 'nuevo') {
        nombre = document.getElementById('nombre').value.trim();
        if (!nombre) {
            showAlert('Por favor ingresa un nombre', 'warning');
            document.getElementById('nombre').focus();
            return;
        }
    } else {
        nombre = selectedPersona;
        if (!nombre) {
            showAlert('Por favor selecciona una persona', 'warning');
            return;
        }
    }
    
    // Iniciar captura
    capturing = true;
    stats = {
        fotosCapturadas: 0,
        fotosAceptadas: 0,
        fotosRechazadas: 0,
        calidadTotal: 0,
        variacionIndex: 0
    };
    
    // Actualizar UI
    document.getElementById('captureBtn').disabled = true;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('nombre').disabled = true;
    document.getElementById('modoNuevo').disabled = true;
    document.getElementById('modoExistente').disabled = true;
    
    // Mostrar overlay de instrucciones
    await showVariationInstructions();
}

async function showVariationInstructions() {
    if (stats.variacionIndex >= variaciones.length) {
        // Captura completada
        await finalizarCaptura();
        return;
    }
    
    const variacion = variaciones[stats.variacionIndex];
    
    // Actualizar UI con informaci√≥n de la variaci√≥n
    document.getElementById('variationIcon').textContent = variacion.icon;
    document.getElementById('variationTitle').textContent = variacion.nombre;
    document.getElementById('currentVariationIcon').textContent = variacion.icon;
    document.getElementById('currentVariation').textContent = variacion.nombre;
    
    // Actualizar instrucciones
    const instruccionesList = document.getElementById('instructionsList');
    instruccionesList.innerHTML = variacion.instrucciones
        .map(inst => `<p class="mb-1">‚Ä¢ ${inst}</p>`)
        .join('');
    
    // Mostrar overlay
    document.getElementById('instructionOverlay').style.display = 'flex';
    
    // Mostrar bot√≥n de saltar si es opcional
    if (!variacion.obligatorio) {
        document.getElementById('skipBtn').style.display = 'block';
    } else {
        document.getElementById('skipBtn').style.display = 'none';
    }
    
    // Countdown de 3 segundos
    await countdown();
    
    // Ocultar overlay y comenzar captura
    document.getElementById('instructionOverlay').style.display = 'none';
    
    // Iniciar captura de esta variaci√≥n
    captureVariation(variacion);
}

async function countdown() {
    const countdownDisplay = document.getElementById('countdownDisplay');
    const countdownNumber = countdownDisplay.querySelector('.countdown-number');
    
    countdownDisplay.style.display = 'block';
    
    for (let i = 3; i > 0; i--) {
        countdownNumber.textContent = i;
        await sleep(1000);
    }
    
    countdownDisplay.style.display = 'none';
}

function captureVariation(variacion) {
    let fotosCapturadasVariacion = 0;
    const totalFotos = variacion.fotos;
    
    // Intervalo de captura (cada 500ms)
    captureInterval = setInterval(async () => {
        if (!capturing || fotosCapturadasVariacion >= totalFotos) {
            clearInterval(captureInterval);
            
            if (fotosCapturadasVariacion >= totalFotos) {
                // Variaci√≥n completada
                markVariationComplete(variacion.id);
                stats.variacionIndex++;
                await sleep(500);
                await showVariationInstructions();
            }
            return;
        }
        
        // Capturar frame
        await captureFrame(variacion, fotosCapturadasVariacion, totalFotos);
        fotosCapturadasVariacion++;
        
    }, 500); // Captura cada 500ms
}

async function captureFrame(variacion, index, total) {
    // Dibujar frame en canvas
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convertir a blob
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.85));
    
    // Crear FormData
    const formData = new FormData();
    const nombre = currentMode === 'nuevo' 
        ? document.getElementById('nombre').value.trim()
        : selectedPersona;
    
    formData.append('image', blob, `${variacion.id}_${index}.jpg`);
    formData.append('nombre', nombre);
    formData.append('variacion', variacion.id);
    
    try {
        const response = await fetch('/api/save_capture', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            stats.fotosCapturadas++;
            stats.fotosAceptadas++;
            if (data.quality) {
                stats.calidadTotal += data.quality;
            }
        } else {
            stats.fotosRechazadas++;
        }
        
        // Actualizar UI
        updateStats(index + 1, total);
        
    } catch (error) {
        console.error('Error capturando foto:', error);
        stats.fotosRechazadas++;
        updateStats(index + 1, total);
    }
}

function updateStats(currentPhoto, totalPhotos) {
    // Actualizar contadores
    document.getElementById('fotosCapturadas').textContent = stats.fotosCapturadas;
    document.getElementById('fotosAceptadas').textContent = stats.fotosAceptadas;
    document.getElementById('fotosRechazadas').textContent = stats.fotosRechazadas;
    
    // Calcular calidad promedio
    if (stats.fotosAceptadas > 0) {
        const calidadPromedio = (stats.calidadTotal / stats.fotosAceptadas).toFixed(1);
        document.getElementById('calidadPromedio').textContent = `${calidadPromedio}%`;
    }
    
    // Actualizar progreso de variaci√≥n
    const percentage = (currentPhoto / totalPhotos) * 100;
    document.getElementById('variationProgress').textContent = `${currentPhoto}/${totalPhotos}`;
    document.getElementById('variationBar').style.width = `${percentage}%`;
    
    // Calcular progreso total
    const totalFotosObjetivo = variaciones.reduce((sum, v) => sum + v.fotos, 0);
    const progressPercentage = (stats.fotosCapturadas / totalFotosObjetivo) * 100;
    document.getElementById('progressBar').style.width = `${progressPercentage}%`;
    document.getElementById('progressPercent').textContent = `${progressPercentage.toFixed(0)}%`;
    document.getElementById('fotosTotal').textContent = totalFotosObjetivo;
}

function markVariationComplete(variationId) {
    const item = document.querySelector(`.variation-item[data-variation="${variationId}"]`);
    if (item) {
        const statusIcon = item.querySelector('.variation-status i');
        statusIcon.className = 'bi bi-check-circle-fill text-success';
    }
}

function skipVariation() {
    if (captureInterval) {
        clearInterval(captureInterval);
    }
    
    const variacion = variaciones[stats.variacionIndex];
    markVariationComplete(variacion.id);
    
    stats.variacionIndex++;
    showVariationInstructions();
}

async function finalizarCaptura() {
    capturing = false;
    
    if (captureInterval) {
        clearInterval(captureInterval);
    }
    
    // Entrenar modelo
    showAlert('üéâ ¬°Captura completada! Entrenando modelo...', 'info');
    
    try {
        const response = await fetch('/api/train', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(`‚úÖ ¬°Proceso completado! Se capturaron ${stats.fotosCapturadas} fotos y el modelo fue entrenado exitosamente.`, 'success', 5000);
        } else {
            showAlert('‚ö†Ô∏è Captura completada pero hubo un error al entrenar el modelo', 'warning');
        }
        
    } catch (error) {
        console.error('Error entrenando modelo:', error);
        showAlert('‚ö†Ô∏è Captura completada pero hubo un error al entrenar el modelo', 'warning');
    }
    
    // Resetear UI
    setTimeout(() => {
        location.reload();
    }, 3000);
}

function stopCapture() {
    capturing = false;
    
    if (captureInterval) {
        clearInterval(captureInterval);
        captureInterval = null;
    }
    
    // Resetear UI
    document.getElementById('captureBtn').disabled = false;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('nombre').disabled = false;
    document.getElementById('modoNuevo').disabled = false;
    document.getElementById('modoExistente').disabled = false;
    document.getElementById('instructionOverlay').style.display = 'none';
}

// ============================================================
// UTILIDADES
// ============================================================
function showAlert(message, type = 'info', duration = 4000) {
    const container = document.getElementById('alertContainer');
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.role = 'alert';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(alert);
    
    if (duration > 0) {
        setTimeout(() => {
            alert.remove();
        }, duration);
    }
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ============================================================
// DETECCI√ìN DE DISPOSITIVO M√ìVIL
// ============================================================
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

if (isMobile) {
    console.log('üì± Dispositivo m√≥vil detectado');
    // Ajustes espec√≠ficos para m√≥viles si son necesarios
    document.body.classList.add('mobile-device');
}

// ============================================================
// LIMPIEZA AL SALIR
// ============================================================
window.addEventListener('beforeunload', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
});

console.log('‚úÖ CoreFace-AI v2.0 - Sistema de captura listo');
</script>

<style>
/* Estilos adicionales para el overlay de instrucciones */
.instruction-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.instruction-content {
    text-align: center;
    padding: 2rem;
    max-width: 500px;
}

.instruction-icon {
    font-size: 4rem;
    animation: pulse 2s ease-in-out infinite;
}

.instruction-list {
    background: rgba(255, 255, 255, 0.1);
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1rem;
}

.preparation-countdown {
    margin-top: 2rem;
}

.countdown-number {
    font-size: 6rem;
    font-weight: bold;
    color: #00d4ff;
    text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
    animation: countdownPulse 1s ease-in-out;
}

.countdown-text {
    font-size: 1.5rem;
    color: white;
    margin-top: 0.5rem;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

@keyframes countdownPulse {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
}

.video-container {
    position: relative;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
}

.overlay-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

/* Responsive para m√≥viles */
@media (max-width: 768px) {
    .instruction-content {
        padding: 1rem;
    }
    
    .instruction-icon {
        font-size: 3rem;
    }
    
    .countdown-number {
        font-size: 4rem;
    }
    
    .countdown-text {
        font-size: 1.2rem;
    }
    
    h3 {
        font-size: 1.5rem;
    }
}

/* Mejoras para dispositivos m√≥viles */
.mobile-device video {
    object-fit: cover;
}

.mobile-device .btn-lg {
    padding: 0.75rem 1rem;
    font-size: 1rem;
}
</style>
{% endblock %}