{% extends "base.html" %}

{% block title %}Reconocimiento en Tiempo Real - CoreFace-AI{% endblock %}

{% block extra_css %}
<style>
    .recognition-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    .video-section {
        background: #1a1a1a;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .video-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 4/3;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        border: 3px solid #333;
    }

    #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .video-controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: center;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-success {
        background: linear-gradient(135deg, #00c853, #00e676);
        color: white;
    }

    .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #d32f2f, #f44336);
        color: white;
    }

    .btn-danger:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
    }

    .btn-info {
        background: linear-gradient(135deg, #0288d1, #03a9f4);
        color: white;
    }

    .stats-panel {
        background: linear-gradient(135deg, #1e1e1e, #2d2d2d);
        border-radius: 15px;
        padding: 20px;
        color: white;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s;
    }

    .stat-card:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateX(5px);
    }

    .stat-label {
        font-size: 12px;
        color: #aaa;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #00e676;
    }

    .detected-faces {
        margin-top: 20px;
    }

    .face-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #00e676;
        animation: slideIn 0.3s ease-out;
    }

    .face-card.unknown {
        border-left-color: #f44336;
    }

    .face-card.medium {
        border-left-color: #ff9800;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .face-name {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .confidence-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
    }

    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #00c853, #00e676);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .confidence-fill.medium {
        background: linear-gradient(90deg, #f57c00, #ff9800);
    }

    .confidence-fill.low {
        background: linear-gradient(90deg, #c62828, #f44336);
    }

    .fps-counter {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: #00e676;
        padding: 8px 12px;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 14px;
        z-index: 10;
    }

    .recording-indicator {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(244, 67, 54, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: bold;
        font-size: 14px;
        display: none;
        align-items: center;
        gap: 8px;
        z-index: 10;
    }

    .recording-indicator.active {
        display: flex;
    }

    .recording-dot {
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .alert-success {
        background: linear-gradient(135deg, #00c853, #00e676);
        color: white;
    }

    .alert-error {
        background: linear-gradient(135deg, #d32f2f, #f44336);
        color: white;
    }

    .confidence-legend {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
    }

    .legend-title {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #fff;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 8px 0;
        font-size: 13px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }

    .face-details {
        font-size: 12px;
        color: #aaa;
        margin-top: 8px;
        display: flex;
        justify-content: space-between;
    }

    .loading-spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 3px solid #00e676;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 968px) {
        .recognition-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    <h2 style="text-align: center; margin-bottom: 10px;">üîç Reconocimiento Facial en Tiempo Real</h2>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">
        Detecci√≥n y reconocimiento avanzado con an√°lisis de confianza
    </p>

    {% if not modelo_cargado %}
    <div class="alert alert-error">
        ‚ùå No hay modelo entrenado. Ve a <a href="/admin" style="color: white; text-decoration: underline; font-weight: bold;">Administraci√≥n</a> para entrenar uno.
    </div>
    {% else %}
    <div class="alert alert-success">
        ‚úÖ Sistema listo. Personas registradas: <strong>{{ personas|join(', ') }}</strong>
    </div>
    {% endif %}

    <div class="recognition-container">
        <!-- Panel de Video -->
        <div class="video-section">
            <h3 style="color: white; margin-bottom: 15px;">üìπ C√°mara en Vivo</h3>
            
            <div class="video-wrapper">
                <div class="recording-indicator" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    <span>RECONOCIENDO</span>
                </div>
                <div class="fps-counter" id="fpsCounter">0 FPS</div>
                <video id="video" autoplay playsinline></video>
                <canvas id="overlay"></canvas>
            </div>

            <div class="video-controls">
                <button id="startBtn" class="btn btn-success" {% if not modelo_cargado %}disabled{% endif %}>
                    <span>üé•</span>
                    <span>Iniciar Reconocimiento</span>
                </button>
                <button id="stopBtn" class="btn btn-danger" disabled>
                    <span>‚èπÔ∏è</span>
                    <span>Detener</span>
                </button>
                <button id="screenshotBtn" class="btn btn-info" disabled>
                    <span>üì∏</span>
                    <span>Captura</span>
                </button>
            </div>
        </div>

        <!-- Panel de Estad√≠sticas -->
        <div class="stats-panel">
            <h3 style="margin-bottom: 20px;">üìä Estad√≠sticas en Tiempo Real</h3>
            
            <div class="stat-card">
                <div class="stat-label">Rostros Detectados</div>
                <div class="stat-value" id="facesCount">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">FPS Promedio</div>
                <div class="stat-value" id="avgFps">0.0</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Frames Procesados</div>
                <div class="stat-value" id="framesCount">0</div>
            </div>

            <div class="detected-faces">
                <h4 style="margin-bottom: 15px;">üë• Rostros Reconocidos</h4>
                <div id="facesList">
                    <p style="color: #666; text-align: center;">
                        Esperando detecci√≥n...
                    </p>
                </div>
            </div>

            <div class="confidence-legend">
                <div class="legend-title">Nivel de Confianza</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00e676;"></div>
                    <span>üü¢ Alta (< 50)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>üü† Media (50-80)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f44336;"></div>
                    <span>üî¥ Baja (> 80)</span>
                </div>
            </div>
        </div>
    </div>
</div>

<canvas id="canvas" style="display: none;"></canvas>
{% endblock %}

{% block extra_js %}
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const overlay = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const overlayCtx = overlay.getContext('2d');

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const screenshotBtn = document.getElementById('screenshotBtn');

const fpsCounter = document.getElementById('fpsCounter');
const avgFpsDisplay = document.getElementById('avgFps');
const facesCountDisplay = document.getElementById('facesCount');
const framesCountDisplay = document.getElementById('framesCount');
const facesList = document.getElementById('facesList');
const recordingIndicator = document.getElementById('recordingIndicator');

let stream = null;
let recognizing = false;
let recognizeInterval = null;
let framesProcessed = 0;
let fpsHistory = [];
let lastFrameTime = Date.now();
let screenshotCount = 0;

// Iniciar reconocimiento
startBtn.addEventListener('click', async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'user'
            } 
        });
        
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            const aspectRatio = video.videoWidth / video.videoHeight;
            overlay.width = video.videoWidth;
            overlay.height = video.videoHeight;
        };
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        screenshotBtn.disabled = false;
        recognizing = true;
        recordingIndicator.classList.add('active');
        
        framesProcessed = 0;
        fpsHistory = [];
        
        // Iniciar reconocimiento (cada 300ms para mejor rendimiento)
        recognizeInterval = setInterval(reconocerFrame, 300);
        
    } catch (err) {
        alert('‚ùå Error al acceder a la c√°mara: ' + err.message);
        console.error(err);
    }
});

// Detener reconocimiento
stopBtn.addEventListener('click', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        
        startBtn.disabled = false;
        stopBtn.disabled = true;
        screenshotBtn.disabled = true;
        recognizing = false;
        recordingIndicator.classList.remove('active');
        
        if (recognizeInterval) {
            clearInterval(recognizeInterval);
        }
        
        overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
        facesList.innerHTML = '<p style="color: #666; text-align: center;">Reconocimiento detenido</p>';
        fpsCounter.textContent = '0 FPS';
    }
});

// Screenshot
screenshotBtn.addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `coreface_screenshot_${++screenshotCount}.jpg`;
        a.click();
        URL.revokeObjectURL(url);
        
        // Mostrar notificaci√≥n
        showNotification('üì∏ Captura guardada');
    }, 'image/jpeg', 0.95);
});

// Reconocer frame
async function reconocerFrame() {
    if (!recognizing) return;
    
    const now = Date.now();
    const fps = 1000 / (now - lastFrameTime);
    lastFrameTime = now;
    
    fpsHistory.push(fps);
    if (fpsHistory.length > 30) fpsHistory.shift();
    
    const avgFps = fpsHistory.reduce((a, b) => a + b, 0) / fpsHistory.length;
    fpsCounter.textContent = `${avgFps.toFixed(1)} FPS`;
    avgFpsDisplay.textContent = avgFps.toFixed(1);
    
    framesProcessed++;
    framesCountDisplay.textContent = framesProcessed;
    
    // Capturar frame
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.85);
    
    try {
        const response = await fetch('/api/recognize_frame', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ image: imageData })
        });
        
        const result = await response.json();
        
        if (result.success && result.faces) {
            mostrarResultados(result.faces);
        } else {
            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
            facesList.innerHTML = '<p style="color: #666; text-align: center;">No se detectaron rostros</p>';
            facesCountDisplay.textContent = '0';
        }
    } catch (err) {
        console.error('Error en reconocimiento:', err);
    }
}

// Mostrar resultados
function mostrarResultados(faces) {
    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
    
    facesCountDisplay.textContent = faces.length;
    
    if (faces.length === 0) {
        facesList.innerHTML = '<p style="color: #666; text-align: center;">No se detectaron rostros</p>';
        return;
    }
    
    let html = '';
    
    faces.forEach((face, index) => {
        // Determinar color seg√∫n confianza
        let color, status, statusIcon, confidenceClass;
        
        if (face.confidence < 50) {
            color = '#00e676';
            status = 'high';
            statusIcon = 'üü¢';
            confidenceClass = '';
        } else if (face.confidence < 80) {
            color = '#ff9800';
            status = 'medium';
            statusIcon = 'üü†';
            confidenceClass = 'medium';
        } else {
            color = '#f44336';
            status = 'low';
            statusIcon = 'üî¥';
            confidenceClass = 'low';
        }
        
        const isUnknown = face.name === 'Desconocido';
        
        // Dibujar en overlay
        const x = face.x;
        const y = face.y;
        const w = face.width;
        const h = face.height;
        
        // Rect√°ngulo con esquinas redondeadas
        drawRoundedRect(overlayCtx, x, y, w, h, 10, color, 3);
        
        // Fondo del nombre
        overlayCtx.fillStyle = color;
        overlayCtx.fillRect(x, y - 35, w, 35);
        
        // Nombre
        overlayCtx.fillStyle = '#FFFFFF';
        overlayCtx.font = 'bold 16px Arial';
        overlayCtx.fillText(face.name, x + 8, y - 14);
        
        // Confianza
        overlayCtx.font = '12px Arial';
        overlayCtx.fillText(`${(100 - face.confidence).toFixed(1)}%`, x + 8, y - 2);
        
        // Puntos en las esquinas (efecto sci-fi)
        drawCornerMarkers(overlayCtx, x, y, w, h, color);
        
        // Tarjeta en el panel
        const cardClass = isUnknown ? 'face-card unknown' : 
                         status === 'medium' ? 'face-card medium' : 'face-card';
        
        html += `
            <div class="${cardClass}">
                <div class="face-name">
                    ${statusIcon}
                    <span>${face.name}</span>
                </div>
                <div class="face-details">
                    <span>Confianza: ${(100 - face.confidence).toFixed(1)}%</span>
                    <span>ID: #${index + 1}</span>
                </div>
                <div class="confidence-bar">
                    <div class="confidence-fill ${confidenceClass}" 
                         style="width: ${100 - face.confidence}%"></div>
                </div>
            </div>
        `;
    });
    
    facesList.innerHTML = html;
}

// Dibujar rect√°ngulo con esquinas redondeadas
function drawRoundedRect(ctx, x, y, width, height, radius, color, lineWidth) {
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
    ctx.stroke();
}

// Dibujar marcadores en las esquinas
function drawCornerMarkers(ctx, x, y, w, h, color) {
    const markerSize = 15;
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    
    // Esquina superior izquierda
    ctx.beginPath();
    ctx.moveTo(x, y + markerSize);
    ctx.lineTo(x, y);
    ctx.lineTo(x + markerSize, y);
    ctx.stroke();
    
    // Esquina superior derecha
    ctx.beginPath();
    ctx.moveTo(x + w - markerSize, y);
    ctx.lineTo(x + w, y);
    ctx.lineTo(x + w, y + markerSize);
    ctx.stroke();
    
    // Esquina inferior izquierda
    ctx.beginPath();
    ctx.moveTo(x, y + h - markerSize);
    ctx.lineTo(x, y + h);
    ctx.lineTo(x + markerSize, y + h);
    ctx.stroke();
    
    // Esquina inferior derecha
    ctx.beginPath();
    ctx.moveTo(x + w - markerSize, y + h);
    ctx.lineTo(x + w, y + h);
    ctx.lineTo(x + w, y + h - markerSize);
    ctx.stroke();
}

// Notificaci√≥n
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #00e676;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 230, 118, 0.4);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}
</script>
{% endblock %}